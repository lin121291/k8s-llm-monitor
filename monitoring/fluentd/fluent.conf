# Input sources
<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<source>
  @type kubernetes_logs
  @label @kubernetes
  namespace_name ai-monitor
  read_from_head true
  <parse>
    @type json
    json_parser json
  </parse>
</source>

# Kubernetes logs processing
<label @kubernetes>
  <match kubernetes.**>
    @type kafka2
    brokers kafka:9092
    topic_key topic
    default_topic service-logs
    
    <format>
      @type json
    </format>
    
    <buffer>
      @type file
      path /fluentd/log/buffer/kubernetes
      flush_interval 10s
      chunk_limit_size 8MB
    </buffer>
  </match>
</label>

# Application logs processing
<filter **>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    timestamp ${time}
    log_level ${record["level"] || "INFO"}
  </record>
</filter>

# Route to Kafka based on log level
<match **>
  @type copy
  
  <store>
    @type kafka2
    brokers kafka:9092
    topic_key topic
    default_topic service-logs
    
    <format>
      @type json
    </format>
    
    <buffer>
      @type file
      path /fluentd/log/buffer/logs
      flush_interval 5s
      chunk_limit_size 8MB
    </buffer>
  </store>
  
  # Send errors and warnings to alerts topic
  <store>
    @type kafka2
    brokers kafka:9092
    topic service-alerts
    
    <filter>
      @type grep
      <regexp>
        key log_level
        pattern (ERROR|WARNING|CRITICAL)
      </regexp>
    </filter>
    
    <format>
      @type json
    </format>
    
    <buffer>
      @type file
      path /fluentd/log/buffer/alerts
      flush_interval 1s
      chunk_limit_size 2MB
    </buffer>
  </store>
</match>